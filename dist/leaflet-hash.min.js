/* Leaflet Hash - ClaudioCas Mod [Rc3 Leaflet BugFix] 12/08/2016 
https://github.com/ClaudioCas/leaflet-hash
*/
(function(){L.Hash=L.Class.extend({initialize:function(a,b){return this.map=a,this.options=b||{},this.options.path||(this.options.lc?this.options.path="{base}/{z}/{lat}/{lng}":this.options.path="{z}/{lat}/{lng}"),this.options.lc&&!this.options.formatBase&&(this.options.formatBase=[/[\s\:A-Z]/g,function(a){return a.match(/\s/)?"_":a.match(/\:/)?"":a.match(/[A-Z]/)?a.toLowerCase():void 0}]),location.hash&&this.updateFromState(this.parseHash(location.hash)),this.map._loaded?this.startListning():this.map.on("load",this.startListning,this)},startListning:function(){var a,b=this;return location.hash&&this.updateFromState(this.parseHash(location.hash)),history.pushState?(location.hash||history.replaceState.apply(history,this.formatState()),window.onpopstate=function(a){if(a.state)return b.updateFromState(a.state)},this.map.on("moveend",function(){var a;if(a=b.formatState(),location.hash!==a[2]&&!b.moving)return history.pushState.apply(history,a)})):(location.hash||(location.hash=this.formatState()[2]),a=function(){var a;if(a=b.formatState(),location.hash!==a[2]&&!b.moving)return location.hash=a[2]},this.map.on("moveend",a),"onhashchange"in window&&(void 0===window.documentMode||window.documentMode>7)?window.onhashchange=function(){if(location.hash)return b.updateFromState(b.parseHash(location.hash))}:this.hashChangeInterval=setInterval(a,50)),this.map.on("baselayerchange",function(a){var c,d;if(b.base=(d=a.name).replace.apply(d,b.options.formatBase),c=b.formatState(),history.pushState){if(location.hash!==c[2]&&!b.moving)return history.pushState.apply(history,c)}else if(location.hash!==c[2]&&!b.moving)return location.hash=c[2]})},parseHash:function(a){var b,c,d,e,f,g,h,i,j;return h=this.options.path.split("/"),i=h.indexOf("{z}"),d=h.indexOf("{lat}"),e=h.indexOf("{lng}"),0===a.indexOf("#")&&(a=a.substr(1)),b=a.split("/"),b.length>2&&(j=parseFloat(b[i]),c=parseFloat(b[d]),f=parseFloat(b[e]),!(isNaN(j)||isNaN(c)||isNaN(f))&&(g={center:new L.LatLng(c,f),zoom:j},b.length>3?(g.base=b[h.indexOf("{base}")],g):g))},updateFromState:function(a){if(!this.moving&&a)return this.moving=!0,this.map.setView(a.center,a.zoom),a.base&&this.setBase(a.base),this.moving=!1,!0},formatState:function(){var a,b,c,d,e;return a=this.map.getCenter(),e=this.map.getZoom(),b=Math.max(0,Math.ceil(Math.log(e)/Math.LN2)),c={center:a,zoom:e},d={lat:a.lat.toFixed(b),lng:a.lng.toFixed(b),z:e},this.options.path.indexOf("{base}")>-1&&(c.base=this.getBase(),d.base=c.base),[c,"a","#"+L.Util.template(this.options.path,d)]},setBase:function(a){var b,c,d,e;for(this.base=a,c=this.options.lc._form.getElementsByTagName("input"),d=c.length,b=0;b<d;){if("leaflet-base-layers"===c[b].name&&(e=this.options.lc._layers[b].name).replace.apply(e,this.options.formatBase)===a)return c[b].checked=!0,this.options.lc._onInputClick(),!0;b++}},getBase:function(){var a,b,c,d;if(this.base)return this.base;for(b=this.options.lc._form.getElementsByTagName("input"),c=b.length,a=0;a<c;){if("leaflet-base-layers"===b[a].name&&b[a].checked)return this.base=(d=this.options.lc._layers[a].name).replace.apply(d,this.options.formatBase),this.base;a++}return!1},remove:function(){return this.map.off("moveend"),window.onpopstate&&(window.onpopstate=null),location.hash="",clearInterval(this.hashChangeInterval)}}),L.hash=function(a,b){return new L.Hash(a,b)},L.Map.include({addHash:function(a){return this._hash=L.hash(this,a),this},removeHash:function(){return this._hash.remove(),this}})}).call(this);